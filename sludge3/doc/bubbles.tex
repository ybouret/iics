\documentclass[aps]{revtex4}
\usepackage{graphicx}
\usepackage{amssymb,amsfonts,amsmath,amsthm}
\usepackage{chemarr}
\usepackage{bm}
\usepackage{pslatex}
\usepackage{mathptmx}
\usepackage{xfrac}

%% concentration notations
\newcommand{\mymat}[1]{\boldsymbol{#1}}
\newcommand{\mytrn}[1]{{#1}^{\mathsf{T}}}
\newcommand{\myvec}[1]{\overrightarrow{#1}}
\newcommand{\mygrad}{\vec{\nabla}}
\newcommand{\myhess}{\mathcal{H}}



\begin{document}
\title{Differential Bubbles}
\maketitle

\section{Differential Properties}

\subsection{Tangent Field}
Let us assume that we have three vectors $\vec{M}_-$, $\vec{M}_0$ and $\vec{M}_+$, with
$t_-=\left\vert \myvec{M_0M_-}\right\vert$ and $t_+=\left\vert \myvec{M_0M_+}\right\vert$.
The regular curve approximation is
\begin{equation}
	\vec{M}(t) = \vec{M}_0 + t \partial_t \vec{M} + \frac{1}{2} t^2 \partial_{t}^2 \vec{M}
\end{equation}
so that
\begin{equation}
\left\lbrace
\begin{array}{rcl}
	\myvec{M_0M_-} & = & -t_- \partial_t \vec{M} + \frac{1}{2} t_-^2 \partial_{t}^2 \vec{M}\\
	\myvec{M_0M_+} & = &  t_+ \partial_t \vec{M} + \frac{1}{2} t_+^2 \partial_{t}^2 \vec{M}.\\
\end{array}
\right.
\end{equation}
Setting

\begin{equation}
\left\lbrace
\begin{array}{rcl}
	\vec{V}_- & = & \frac{1}{t_-} \myvec{M_0M_-}\\
	\vec{V}_+ & = & \frac{1}{t_+} \myvec{M_0M_+}\\
\end{array}
\right.
\end{equation}
we shall solve
\begin{equation}
	\left\lbrace
	\begin{array}{rcl}
	\vec{V}_- & = & -\partial_t \vec{M} + \frac{1}{2} t_- \partial_{t}^2 \vec{M}\\
	\vec{V}_+ & = & \partial_t \vec{M} + \frac{1}{2} t_+ \partial_{t}^2 \vec{M}.\\
	\end{array}
\right.
\end{equation}

The first order approximation of the tangent field is
\begin{equation}
	\partial_t \vec{M} =  \frac{1}{t_-+t_+} \left(t_-\vec{V}_+ - t_+ \vec{V}_-\right)
\end{equation}

\subsection{Differential properties}
Let us assume that $\vec{M}(t)$ is a local parametric estimation of a contour.
Then the tangent vector around $\vec{M}_0$ is
\begin{equation}
	\partial_t \vec{M} = 
	 \frac{1}{t_-+t_+} \left\lbrack t_-\left(\frac{1}{t_+}\myvec{M_0M_+}\right) - t_+ \left(\frac{1}{t_-}\myvec{M_0M_-}\right)\right\rbrack
\end{equation}
and the tangent vector is
\begin{equation}
	\vec{\tau} = \frac{1}{\vert \partial_t \vec{M} \vert} \partial_t \vec{M}
\end{equation}
and the normal vector is
\begin{equation}
	\vec{n} = \begin{bmatrix}
		-\tau_y\\
		\tau_x\\
	\end{bmatrix}.
\end{equation}
If $s$ were a curvilinear abscissa then we would have
\begin{equation}
	\partial_s \vec{\tau} = \kappa \vec{n}
\end{equation}
so that
\begin{equation}
	\kappa = \frac{1}{\vert\partial_t \vec{M}\vert} \vec{n}.\partial_t \vec{\tau}
\end{equation}
with
\begin{equation}
	\partial_t \vec{\tau} = \frac{1}{t_-+t_+}
	 \left\lbrack 
	 t_-\left(\frac{1}{t_+}\left(\vec{\tau}_+ - \vec{\tau}_0\right)\right) 
	- 
	t_+ \left(\frac{1}{t_-}\left(\vec{\tau}_- - \vec{\tau}_0\right)\right)
	\right\rbrack.
\end{equation}

So that the differential properties can be determined in two passes:
\begin{enumerate}
	\item Estimate $\partial_t \vec{M}$, deduce $\vec{\tau}$ and $\vec{n}$, and store $\vert\partial_t \vec{M}\vert$,
	\item then estimate $\partial_t \vec{\tau}$ and deduce $\kappa = \frac{1}{\vert\partial_t \vec{M}\vert} \vec{n}.\partial_t \vec{\tau}$.
\end{enumerate}

\section{Segmentation}
\subsection{Computing Junctions with a Grid}

To be sure that a vector between to consecutive tracers has only ONE intersection with an horizontal or a vertical
grid, we must ensure that this distance is less than $\lambda=\min(\delta x_i,\delta y_j)/2$.

\begin{center}
\includegraphics[scale=1]{grid.eps}
\end{center}

There is an intersection with an Horizontal axis if one of the point is Not in TOP and Not in BOTTOM and
\begin{itemize}
	\item the other point is in TOP or in BOTTOM
	\item or the other point is between two different horizontal axis (i.e. directly above or below).
\end{itemize}

There is an intersection with a Vertical axis if one of the point is Not in LEFT and Not in RIGHT and
\begin{itemize}
	\item the other point is in LEFT or in RIGHT
	\item or the other point is between to different vertical axis (i.e. directly at left or at right). 
\end{itemize}

\subsection{Segmentation by Ray Casting}
For non penetrating bubbles, the successive junctions pairs on any axis is the sequence of inside/outside positions.
When those junctions are within the grid (taking special care of sides), we mark the inner position with the owning bubble ID.

\section{Effective Pressure Field}
We need to estimate the pressure gradient and Laplacian around any bulk position,
using the \textbf{standard} discretizations.

\subsection{Entering Pressure Fields}
Let us assume that the points $x_{i-1}$ and $x_i$ are in the bulk, and that there is
an intersection with a bubble at $x_i+\phi$.
The length of the segment
is
$$
	L = \delta_x + \phi.
$$ 
At this intersection, there is a pressure $P_\phi = P_{bubble} - \gamma \kappa_\phi$.
The pressure gradient while \textbf{entering} the bubble can be estimated by
$$
	\sigma = \dfrac{P_\phi - P_{i-1}}{L}.
$$
We can define an \textbf{Order 1 Entering Pressure} $P^{E_1}$ by
$$
	\sigma = \dfrac{P^{E_1}_{i+1}-P_{i-1}}{2\delta_x} 
$$
so that
$$
	P^{E_1}_{i+1} = P_{i-1} + 2\delta_x\sigma.
$$
Using $h= \dfrac{L}{2}$, the pressure at the middle of the segment can be expressed as
$$
	P_{i,m}^E = \dfrac{1}{\delta_x} \left\lbrack
	h P_i + \left(\delta_x - h\right) P_{i-1}
	\right\rbrack
$$
We can define an \textbf{Order 2 Entering Pressure} $P^{E_2}$ by
$$
	\partial_x^2 P_i = \dfrac{P_{i-1} - 2P_{i,m}^E + P_\phi}{{h}^2} = \dfrac{P_{i-1}- 2P_i + P_{i+1}^{{E_2}}}{\delta_x^2}
$$
so that
$$
	P_{i+1}^{{E_2}} = 2P_i - P_{i-1} + \left(\dfrac{\delta_x}{h}\right)^2
	\left(
		P_{i-1} - 2P_{i,m}^E + P_\phi
	\right)
$$
The contribution to the Gauss-Seidel Method is
$$
	-\dfrac{2}{h\delta_x}
$$

\subsection{Leaving Pressure Fields}
Let us assume that  the points $x_{i}$ and $x_{i+1}$ are in the bulk, and that
theres is an intersection with a bubble at $x_i-\psi$.
At this intersection, there is a pressure $P_\psi=P_{bubble} - \gamma \kappa_\psi$.
The length of the segment is
$$
	L = \psi+\delta_x
$$
The pressure gradient while \textbf{leaving} the bubble can be estimated by
$$
	\sigma = \dfrac{P_{i+1}-P_\psi}{L}.
$$
We can define an \textbf{Order 1 Leaving Pressure} $P^{L_1}$ by
$$
	\sigma = \dfrac{P_{i+1}-P^{L_1}_{i-1}}{2\delta_x}
$$
so that 
$$
	P^{L_1}_{i-1} = P_{i+1} - 2\delta_x \sigma.
$$
Using $h = \dfrac{L}{2}$, the pressure at the middle of the segment can be estimated
by
$$
	P_{i,m}^L = \dfrac{1}{\delta_x} \left\lbrack
	h P_i + \left(\delta_x - h\right) P_{i+1}
	\right\rbrack.
$$
As previously, the \textbf{Order 2 Leaving Pressure} $P^{L_2}$ is
defined by
$$
	P_{i-1}^{L_2} = 2P_i - P_{i+1} + \left(\dfrac{\delta_x}{h}\right)^2
	\left(
		P_\psi - 2P_{i,m}^L + P_{i+1}
	\right)
$$
The contribution to the Gauss-Seidel weight is
$$
	-\dfrac{2}{\delta_x h}
$$

\subsection{Pinched Pressure Fields}
Let us assume that the point $x_i$ is between two bubbles at $x_i+\phi$ and $x_i-\psi$.
We have a segment length 
$$
	L = \phi + \psi 
$$
and a gradient
$$
	\sigma_i = \dfrac{P_\phi - P_\psi}{L}
$$
so that setting
$$
	P^{L_1}_{i-1} = \dfrac{2\delta_x}{L} P_\psi
$$
and
$$
	P^{E_1}_{i+1} = \dfrac{2\delta_x}{L} P_\phi
$$
solves the order 1 estimation.

We use $h=\frac{L}{2}$.
The pressure at the center of the pinch can be expressed like this.
\begin{itemize}
\item If $\phi>\psi$, 
$$
	P_{i,m} = \dfrac{1}{\phi}
	\left\lbrack
		h P_i + \left(\phi-h\right) P_\phi
	\right\rbrack
$$
\item If $\psi>\phi$,  
	$$
		P_{i,m} = \dfrac{1}{\psi}
	\left\lbrack
		h P_i + \left(\psi-h\right) P_\psi
	\right\rbrack
$$
\item Otherwise (numerically), $P_{i,m}=P_i$.
\end{itemize}

The the second derivative of the pressure is estimated by
$$
	\partial_x^2 P_i = \dfrac{P_\psi - 2P_{i,m} + P_\phi}{h^2} =
	\dfrac{P^{L_2}_{i-1} - 2P_i + P^{E_2}_{i+1}}{\delta_x^2}.
$$
We solve the order 2 problem by setting
$$
	P^{L_2}_{i-1} = P^{E_2}_{i+1} = P_i + \dfrac{1}{2}\left(\dfrac{\delta_x}{h}\right)^2 \left( P_\psi - 2P_{i,m} + P_\phi \right)
$$
The contribution to the Gauss-Seidel algorithm are the following
\begin{itemize}
	\item If $\phi>\psi$, it is
	$$
		-\dfrac{2}{h\phi}
	$$
	\item If $\psi>\phi$, it is
	$$
		-\dfrac{2}{h\psi}
	$$
	\item Otherwise, it is 
	$$
		-\dfrac{2}{h^2}
	$$
\end{itemize}
\subsection{Conclusion}

\section{Adaptive Polygon}

\subsection{Problem}
On a grid, we want to remap a polygonized contour with a distance of about $\lambda$ between consecutive vertices.

\subsection{Reduction with Area Conservation}


\section{Local Gradient Estimation}

\subsection{Tangential Gradient}
If we have the contour $\vec{M}(t)$ and the corresponding $P(t)$, then
$$
	\partial_t P = \mygrad P , \partial_t M = \left(\mygrad P . \vec{\tau}\right) \left|\partial_t \vec{M}\right|.
$$

Accordingly, we compute $\partial_t P$ and we use the stored $\left|\partial_t \vec{M}\right|$.

\subsection{Normal Gradient}

\subsubsection{First Attempt}

Let us assume that we have $q$ points $\vec{Q}_1,\ldots,\vec{Q}_{q}$ around a point $\vec{A}$, and that we want to
estimate the pressure gradient along the direction $\vec{u}$, $\vert\vec{u}\vert=1$. 
We also assume that we know the pressure gradients at each $\vec{Q}_i$.
For each point, the local pressure estimation at $\vec{M} = \vec{A} + \mu \vec{u}$ is
$$
	\tilde{P}_i = P_i + \mygrad P_i . \left(\myvec{Q_iA} +\mu \vec{u}\right)
$$
so that the gradient estimation along $\vec{u}$ is
$$
	\dfrac{\partial \tilde{P}_i}{\partial \mu} = \mygrad P_i.\vec{u}.
$$
Now, we need to put some weight on those gradients if $q>1$.
If we define
$$
	D_A =  \sum_{i=1}^q \left\vert \myvec{AQ_i}\right\vert
$$
the we can use a relative weight
$$
	w_i = D_A - \left\vert \myvec{AQ_i}\right\vert \geq 0
$$
with
$$
	\sum_i w_i = (q-1) D_A.
$$

Finally
\begin{itemize}
\item if $q=1$,
	$$
		\mygrad P_A = \mygrad P_1.\vec{u},
	$$
\item if $q>1$,
$$
	\mygrad P_A.\vec{u} = \dfrac{1}{\left(q-1\right)D_A} \left\lbrack \sum_{i=1}^q \left(D_A - \left\vert \myvec{AQ_i}\right\vert\right) \mygrad P_i.\vec{u} \right\rbrack, \;\; D_A =  \sum_{i=1}^q \left\vert \myvec{AQ_i}\right\vert
$$
\end{itemize}

\subsubsection{Second Attempt}
Let us assume that we have $q$ points $\vec{Q}_1,\ldots,\vec{Q}_{q}$ around a point $\vec{A}$, and that we want to
estimate 
$$
	\mygrad P_A = \begin{bmatrix}
	\alpha \\
	\beta
	\end{bmatrix}
$$
with the constraint
$$
	\mygrad P_A . \vec{\tau} = g_t.
$$
We want to minimize
$$
	\chi^2(\alpha,\beta) = \dfrac{1}{2} \sum_{i=1}^q \left\lbrack P_i - \left(P_A+\alpha x_i + \beta y_i\right) \right\rbrack^2
$$
subject to the constraint
$$
	\alpha\tau_x + \beta\tau_y = g_t.
$$
We define the Lagrange multiplier $\mu$ to minimize
$$
	L(\alpha,\beta,\mu) = \chi^2(\alpha,\beta) - \mu \left( \alpha\tau_x + \beta\tau_y - g_t\right).
$$
We find
$$
	\begin{bmatrix}
	\sum_i x_i^2 & \sum_i x_i y_i & -\tau_x\\
	 \sum_i x_i y_i &\sum_i y_i^2 & -\tau_y\\
	\tau_x & \tau_y & 0\\
	\end{bmatrix}
	\begin{bmatrix}
	\alpha\\
	\beta\\
	\mu
	\end{bmatrix}
	=
	\begin{bmatrix}
	\sum_i x_i\left(P_i-P_A\right)\\
	\sum_i y_i\left(P_i-P_A\right)\\
	g_t\\
	\end{bmatrix}
$$

\subsubsection{Third Attempt}
Let us assume that we have $q$ points $\vec{Q}_1,\ldots,\vec{Q}_{q}$ around a point $\vec{A}$, and that we want to
estimate gradient at $\vec{A}$.
We have
$$
	\mygrad P_A = \alpha \vec{\tau} + \beta \vec{n}
$$
so that the pressure at any point $Q_i$ shall be
$$
	P\left(\vec{Q}_i\right)= P_A + \left(\alpha \vec{\tau} + \beta \vec{n}\right).\myvec{AQ_i}
$$
We define the weighted least square
$$
	\chi^2(\beta) = \sum_{i=1}^q w_i \left\lbrack P_i - \left(P_A+\alpha \left(\vec{\tau}.\myvec{AQ_i}\right) + \beta \left(\vec{n}.\myvec{AQ_i}\right) \right)\right\rbrack^2
$$
so that
$$
	\beta = \dfrac{\displaystyle \sum_i w_i \left(\vec{n}.\myvec{AQ_i}\right)
	 \left\lbrack P_i - \left(P_A + \alpha \left(\vec{\tau}.\myvec{AQ_i}\right) \right)\right\rbrack}
	{\displaystyle \sum_i w_i \left(\vec{n}.\myvec{AQ_i}\right)^2}
$$
\end{document}